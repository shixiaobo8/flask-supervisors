{% extends "base/frame_boot_base.html" %}
{% block title %} 用户信息修改 {% endblock %}
{% block content %}
<div id="app">
    <template>
        <el-table
                :data="tableData"
                border
                style="width: 100%">
            <el-table-column
                    fixed
                    prop="ctime"
                    label="创建日期"
                    width="220">
                <template slot-scope="scope">
                    <i class="el-icon-time"></i>
                    <span style="margin-left: 10px">{[ scope.row.ctime ]}</span>
                </template>
            </el-table-column>
            <el-table-column
                    fixed
                    prop="mtime"
                    label="最近修改时间"
                    width="220">
                <template slot-scope="scope">
                    <i class="el-icon-time"></i>
                    <span style="margin-left: 10px">{[ scope.row.mtime ]}</span>
                </template>
            </el-table-column>
            <el-table-column
                    prop="username"
                    label="用户名"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="weixin"
                    label="微信昵称"
                    width="150">
            </el-table-column>
            >
            <el-table-column
                    prop="password"
                    label="密码"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="phone"
                    label="手机号"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="email"
                    label="邮箱"
                    width="220">
            </el-table-column>
            <el-table-column
                    prop="touxiang"
                    label="头像"
                    width="120">
                <template slot-scope="scope">
                    <img :src="scope.row.touxiang" min-width="70" height="70" class='img-circle'
                         alt='{{ current_user.username }}'/>
                </template>
            </el-table-column>
            <el-table-column
                    fixed="right"
                    label="操作"
                    width="200">
                <template slot-scope="scope">
                    <!--<el-row>-->
                    <el-button type="info" icon="el-icon-search" @click="dialogFormVisible = true" size="small">查看
                    </el-button>
                    <el-button type="primary" icon="el-icon-edit" size="mini"
                               @click="handleEdit(scope.$index, scope.row)">编辑
                    </el-button>
                    <el-dialog title="用户个人信息" :visible.sync="dialogFormVisible">
                        <el-form :model="userform" name="userform" status-icon :rules="rules" ref="ruleForm">
                            <el-form-item label="用户名" :label-width="formLabelWidth" prop="username">
                                <el-input v-model="userform.username" auto-complete="off" name="username"></el-input>
                            </el-form-item>
                            <el-form-item label="密码" :label-width="formLabelWidth" prop="password">
                                <el-input v-model="userform.password" auto-complete="off" show-password
                                          name="password"></el-input>
                            </el-form-item>
                            <el-form-item label="密码确认" :label-width="formLabelWidth" prop="checkPass">
                                <el-input v-model="userform.checkPass" auto-complete="off" show-password
                                          name="password"></el-input>
                            </el-form-item>
                            <el-form-item label="邮箱" :label-width="formLabelWidth" prop="email">
                                <el-input v-model="userform.email" auto-complete="off" name="email"></el-input>
                            </el-form-item>
                            <el-form-item label="微信号" :label-width="formLabelWidth" prop="weixin_name">
                                <el-input v-model="userform.weixin_name" auto-complete="off"
                                          name="weixin_name"></el-input>
                            </el-form-item>
                            <el-form-item label="手机号" :label-width="formLabelWidth" prop="phone">
                                <el-input v-model="userform.phone" auto-complete="off" name="phone"></el-input>
                            </el-form-item>
                            <el-form-item label="头像" :label-width="formLabelWidth" prop="touxiang">
                                <el-input v-model="userform.touxiang" auto-complete="off" name="touxiang"></el-input>
                            </el-form-item>
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-form-item>
                                <el-button type="primary" @click="submitForm('userform')">提交</el-button>
                                <el-button @click="resetForm('userform')">重置</el-button>
                            </el-form-item>
                        </div>
                    </el-dialog>
                    <!--</el-row>-->
                </template>
            </el-table-column>
        </el-table>
        <!-- Form -->
    </template>
</div>
<script>
    var Main = {
        delimiters: ['{[', ']}'],
        editFormVisible: true, //默认不显示编辑弹层
        //动态数据
        data() {
            var checkUsername = (rule, value, callback) => {
                if (!value) {
                    return callback(new Error('用户名不能为空'));
                }
                setTimeout(() => {
                    if (!String.length(value) == 0) {
                        callback(new Error('请输入用户名'));
                    } else {
                        if (String.length(value) < 18) {
                            callback(new Error('用户名必须小于18位'));
                        } else {
                            callback();
                        }
                    }
                }, 1000);
            };
            var validatePass = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请输入密码'));
                } else {
                    if (this.ruleForm.checkPass !== '') {
                        this.$refs.ruleForm.validateField('checkPass');
                    }
                    callback();
                }
            };
            var validatePass2 = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请再次输入密码'));
                } else if (value !== this.ruleForm.pass) {
                    callback(new Error('两次输入密码不一致!'));
                } else {
                    callback();
                }
            };
            return {
                tableData: [],
                dialogFormVisible: false,
                form: {
                    username: "{[ this.scope.row.username ]}",
                    password: "",
                    checkPass: "",
                    weixin_name: "",
                    phone: "",
                    email: "",
                    touxiang: "",
                    resource: '',
                    desc: ''
                },
                formLabelWidth: '100px',
                rules: {
                    username: [{validator: checkUsername, required: true, message: '请输入', trigger: 'blur'}],
                    email: [{required: true, message: '请输入', trigger: 'blur'}],
                    password: [{validator: validatePass, required: true, message: '请输入', trigger: 'blur'}],
                    checkPass: [{validator: validatePass2, required: true, message: '请输入', trigger: 'blur'}],
                    phone: [{required: true, message: '请输入', trigger: 'blur'}],
                    weixin_name: [{required: true, message: '请输入', trigger: 'blur'}],
                    touxiang: [{required: true, message: '请输入', trigger: 'blur'}],
                },
            },
                mounted
        :

            function () {
                var _this = this;  //很重要！！
                axios({
                    method: 'get',
                    url: '/houtai/user/info',
                    params: {
                        username: '{{ current_user.username }}'
                    }
                })
                    .then(function (response) {
                        console.log(response.data);
                        _this.tableData = response.data;
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            };
        },
                methods: {
                    // 查看
                    handleClick(row) {
                        this.editFormVisible = false;
                        // this.form = Object.assign({}, row); //这句是关键！！！
                    },
                    // 编辑
                    handleEdit(index, row) {
                        //显示弹框
                        this.dialogFormVisible = true;
                    },
                    submitForm(formName) {
                        this.$refs[formName].validate((valid) => {
                            if (valid) {
                                alert('submit!');
                            } else {
                                console.log('error submit!!');
                                return false;
                            }
                        });
                    },
                    resetForm(formName) {
                        this.$refs[formName].resetFields();
                    }
                }
            },
            var Ctor = Vue.extend(Main);
            new Ctor().$mount('#app');
        };
</script>
{% endblock %}